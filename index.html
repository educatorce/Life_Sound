<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Generador de sonidos Aleatorios</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: #eee;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    canvas {
      border: 1px solid white;
      display: block;
      margin: 10px auto;
      touch-action: none; /* prevent scrolling when drawing on touch */
    }
    .controls {
      margin: 10px;
      max-width: 100%;
      overflow-x: auto;
    }
    select, button, input {
      margin: 5px;
    }
  </style>
</head>
<body>
  <h1> Generador de sonidos Aleatorios</h1>
  <div class="controls">
    <button id="startBtn">Start</button>
    <button id="stopBtn">Stop</button>
    <button id="randomBtn">Randomize Grid</button>
    <button id="clearBtn">Clear Grid</button>
    <button id="recordBtn">Start Recording</button>
    <button id="downloadBtn" disabled>Download Recording</button>

    <br>

    <label>Scale:
      <select id="scaleSelect">
        <option>Major</option>
        <option>Minor</option>
        <option>Dorian</option>
        <option>Phrygian</option>
        <option>Lydian</option>
        <option>Mixolydian</option>
        <option>Locrian</option>
        <option>Harmonic Minor</option>
        <option>Pentatonic Major</option>
        <option>Pentatonic Minor</option>
      </select>
    </label>

    <label>Pitch Mapping:
      <select id="pitchMapping">
        <option value="xy">XY Position</option>
        <option value="neighbors">Neighbor Count</option>
        <option value="direction">Direction Based</option>
        <option value="recursive">Recursive</option>
        <option value="guitar">Guitar Fretboard</option>
      </select>
    </label>

    <label>Playback:
      <select id="playbackPolicy">
        <option value="birth">On Birth</option>
        <option value="death">On Death</option>
        <option value="alive">While Alive</option>
      </select>
    </label>

    <br>

    <label>Synth Layers:
      <input type="checkbox" id="sine" checked>Sine
      <input type="checkbox" id="square">Square
      <input type="checkbox" id="triangle">Triangle
      <input type="checkbox" id="sawtooth">Sawtooth
    </label>

    <br>

    <label>Gain: <input type="range" id="gainControl" min="0" max="1" step="0.01" value="0.2"></label>
    <label>Filter: <input type="range" id="filterControl" min="100" max="20000" step="100" value="20000"></label>
    <label>Polyphony: <input type="number" id="polyphony" min="1" max="16" value="4"></label>
    <label>Speed(ms): <input type="range" id="speedControl" min="50" max="1000" step="50" value="300"></label>
  </div>

  <canvas id="grid"></canvas>

  <script>
    const canvas = document.getElementById("grid");
    const ctx = canvas.getContext("2d");
    const rows = 30, cols = 30;
    let cellSize;
    let grid = Array.from({length: rows}, () => Array(cols).fill(0));
    let running = false;
    let stepInterval = 300;

    function resizeCanvas(){
      const size = Math.min(window.innerWidth-20, window.innerHeight-200);
      canvas.width = size;
      canvas.height = size;
      cellSize = canvas.width / cols;
      drawGrid();
    }
    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    // Audio setup
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const masterGain = audioCtx.createGain();
    const filter = audioCtx.createBiquadFilter();
    filter.type = "lowpass";
    filter.frequency.value = 20000;
    masterGain.gain.value = 0.2;
    masterGain.connect(filter).connect(audioCtx.destination);

    let recorder, recordedChunks = [];

    // ðŸŽ¼ Scales 
    const scales = {
      "Major": [0,2,4,5,7,9,11],
      "Minor": [0,2,3,5,7,8,10],
      "Dorian": [0,2,3,5,7,9,10],
      "Phrygian": [0,1,3,5,7,8,10],
      "Lydian": [0,2,4,6,7,9,11],
      "Mixolydian": [0,2,4,5,7,9,10],
      "Locrian": [0,1,3,5,6,8,10],
      "Harmonic Minor": [0,2,3,5,7,8,11],
      "Pentatonic Major": [0,2,4,7,9],     // 5-note major pentatonic
      "Pentatonic Minor": [0,3,5,7,10]     // 5-note minor pentatonic
    };

    // Helpers
    function getNeighbors(r, c) {
      let sum = 0;
      for (let i=-1;i<=1;i++) for (let j=-1;j<=1;j++) {
        if (i===0 && j===0) continue;
        const nr=(r+i+rows)%rows, nc=(c+j+cols)%cols;
        sum+=grid[nr][nc];
      }
      return sum;
    }

    function nextGen() {
      return grid.map((row,r)=>
        row.map((cell,c)=>{
          const n=getNeighbors(r,c);
          if (cell && (n===2||n===3)) return 1;
          if (!cell && n===3) return 1;
          return 0;
        })
      );
    }

    function drawGrid() {
      ctx.clearRect(0,0,canvas.width,canvas.height);
      for (let r=0;r<rows;r++) {
        for (let c=0;c<cols;c++) {
          if (grid[r][c]) {
            ctx.fillStyle = pitchToColor(getNote(r,c));
            ctx.fillRect(c*cellSize,r*cellSize,cellSize,cellSize);
          } else {
            ctx.strokeStyle="#222";
            ctx.strokeRect(c*cellSize,r*cellSize,cellSize,cellSize);
          }
        }
      }
    }

    // Pitch mapping
    function getNote(r,c) {
      const scale = scales[document.getElementById("scaleSelect").value];
      const mapping = document.getElementById("pitchMapping").value;
      let degree=0;
      if (mapping==="xy") degree=(r+c)%scale.length;
      else if (mapping==="neighbors") degree=getNeighbors(r,c)%scale.length;
      else if (mapping==="direction") degree=((r*cols+c)%scale.length);
      else if (mapping==="recursive") degree=(r*c)%scale.length;
      else if (mapping==="guitar") degree=((r%6)+(c%scale.length))%scale.length;

      let base=60; // MIDI middle C
      return base+scale[degree]+12*Math.floor(r/5);
    }

    function midiToFreq(note){return 440*Math.pow(2,(note-69)/12);}

    function pitchToColor(note){
      const hue=(note%12)*30;
      return `hsl(${hue},70%,50%)`;
    }

    function playNote(note){
      const waveforms=[];
      if (document.getElementById("sine").checked) waveforms.push("sine");
      if (document.getElementById("square").checked) waveforms.push("square");
      if (document.getElementById("triangle").checked) waveforms.push("triangle");
      if (document.getElementById("sawtooth").checked) waveforms.push("sawtooth");

      waveforms.forEach((type)=>{
        const osc=audioCtx.createOscillator();
        const g=audioCtx.createGain();
        osc.type=type;
        osc.frequency.value=midiToFreq(note);
        g.gain.setValueAtTime(0.2,audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+1);
        osc.connect(g).connect(masterGain);
        osc.start();
        osc.stop(audioCtx.currentTime+1);
      });
    }

    function step() {
      if (!running) return;
      let newGrid=nextGen();
      const playback=document.getElementById("playbackPolicy").value;
      let notesToPlay = [];

      for (let r=0;r<rows;r++) for (let c=0;c<cols;c++) {
        if (playback==="birth" && newGrid[r][c]&&!grid[r][c])
          notesToPlay.push(getNote(r,c));
        else if (playback==="death" && !newGrid[r][c]&&grid[r][c])
          notesToPlay.push(getNote(r,c));
        else if (playback==="alive" && newGrid[r][c])
          notesToPlay.push(getNote(r,c));
      }

      const polyphony = parseInt(document.getElementById("polyphony").value) || 4;
      if (notesToPlay.length > polyphony) {
        notesToPlay = notesToPlay.sort(() => Math.random() - 0.5).slice(0, polyphony);
      }

      notesToPlay.forEach(note => playNote(note));

      grid=newGrid;
      drawGrid();
      setTimeout(step, stepInterval);
    }

    // Interaction (mouse + touch)
    let mouseDown=false;

    function getCellFromEvent(e){
      const rect=canvas.getBoundingClientRect();
      let clientX, clientY;
      if (e.touches && e.touches[0]) {
        clientX = e.touches[0].clientX;
        clientY = e.touches[0].clientY;
      } else {
        clientX = e.clientX;
        clientY = e.clientY;
      }
      const x=Math.floor((clientX-rect.left)/cellSize);
      const y=Math.floor((clientY-rect.top)/cellSize);
      return {x,y};
    }

    function toggleCellEvent(e){
      e.preventDefault();
      const {x,y} = getCellFromEvent(e);
      if (x>=0 && x<cols && y>=0 && y<rows) {
        grid[y][x]=1-grid[y][x];
        drawGrid();
      }
    }

    canvas.addEventListener("mousedown",(e)=>{mouseDown=true;toggleCellEvent(e);});
    canvas.addEventListener("mouseup",()=>mouseDown=false);
    canvas.addEventListener("mousemove",(e)=>{if(mouseDown) toggleCellEvent(e);});

    // Touch support
    canvas.addEventListener("touchstart",(e)=>{mouseDown=true;toggleCellEvent(e);});
    canvas.addEventListener("touchend",()=>mouseDown=false);
    canvas.addEventListener("touchmove",(e)=>{if(mouseDown) toggleCellEvent(e);});

    // Controls
    document.getElementById("startBtn").onclick=()=>{running=true;step();};
    document.getElementById("stopBtn").onclick=()=>running=false;
    document.getElementById("clearBtn").onclick=()=>{grid=grid.map(r=>r.map(()=>0));drawGrid();};
    document.getElementById("randomBtn").onclick=()=>{grid=grid.map(r=>r.map(()=>Math.random()>.7?1:0));drawGrid();};
    document.getElementById("gainControl").oninput=e=>masterGain.gain.value=e.target.value;
    document.getElementById("filterControl").oninput=e=>filter.frequency.value=e.target.value;
    document.getElementById("speedControl").oninput=e=>stepInterval=parseInt(e.target.value);

    // Recording
    const dest=audioCtx.createMediaStreamDestination();
    filter.connect(dest);
    recorder=new MediaRecorder(dest.stream);
    recorder.ondataavailable=e=>recordedChunks.push(e.data);
    recorder.onstop=()=>{
      const blob=new Blob(recordedChunks,{type:"audio/webm"});
      recordedChunks=[];
      const url=URL.createObjectURL(blob);
      const link=document.createElement("a");
      link.href=url;
      link.download="life-music.webm";
      link.click();
    };

    document.getElementById("recordBtn").onclick=()=>{
      if(recorder.state==="inactive"){
        recorder.start();
        document.getElementById("recordBtn").innerText="Stop Recording";
      }else{
        recorder.stop();
        document.getElementById("recordBtn").innerText="Start Recording";
      }
    };

    drawGrid();
  </script>
</body>

</html>

